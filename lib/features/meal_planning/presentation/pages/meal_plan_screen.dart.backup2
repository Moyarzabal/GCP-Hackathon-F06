import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../shared/models/meal_plan.dart';
import '../../../../shared/models/shopping_item.dart';
import '../providers/meal_plan_provider.dart';
import '../widgets/meal_plan_square_card.dart';
import '../widgets/meal_detail_dialog.dart';
import '../../../../core/services/adk_api_client.dart';
import '../../../../shared/providers/app_state_provider.dart';

class MealPlanScreen extends ConsumerStatefulWidget {
  const MealPlanScreen({Key? key}) : super(key: key);

  @override
  ConsumerState<MealPlanScreen> createState() => _MealPlanScreenState();
}

class _MealPlanScreenState extends ConsumerState<MealPlanScreen> {
  Map<String, String?> _mealImages = {};
  bool _isGeneratingImages = false;
  bool _isInitialLoading = false;
  final ScrollController _scrollController = ScrollController();
  GlobalKey _shoppingListKey = GlobalKey();
  // æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
  static const Color _baseColor = Color(0xFFF6EACB); // ã‚¯ãƒªãƒ¼ãƒ è‰²
  static const Color _primaryColor = Color(0xFFD4A574); // æ¸©ã‹ã„ãƒ™ãƒ¼ã‚¸ãƒ¥
  static const Color _secondaryColor = Color(0xFFB8956A); // æ·±ã„ãƒ™ãƒ¼ã‚¸ãƒ¥
  static const Color _accentColor = Color(0xFF8B7355); // ãƒ–ãƒ©ã‚¦ãƒ³
  static const Color _textColor = Color(0xFF5D4E37); // ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ©ã‚¦ãƒ³

  @override
  void initState() {
    super.initState();
    // ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«çŒ®ç«‹ã‚’ææ¡ˆ
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _suggestMealPlan();
    });
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final mealPlanAsync = ref.watch(mealPlanProvider);
      // final appState = ref.watch(appStateProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'æœ¬æ—¥ã®çŒ®ç«‹',
          style: TextStyle(fontWeight: FontWeight.bold),
        ),
        backgroundColor: Theme.of(context).colorScheme.surface,
        actions: [
          IconButton(
            icon: Icon(
              Icons.shopping_cart,
              color: _accentColor,
            ),
            tooltip: 'è²·ã„ç‰©ãƒªã‚¹ãƒˆã¸',
            onPressed: _scrollToShoppingList,
          ),
          IconButton(
            icon: Icon(
              Icons.refresh,
              color: _accentColor,
            ),
            onPressed: _showReSuggestConfirmation,
            tooltip: 'çŒ®ç«‹ã‚’å†ææ¡ˆ',
          ),
          IconButton(
            icon: const Icon(Icons.history),
            onPressed: () => _showMealPlanHistory(context),
            tooltip: 'çŒ®ç«‹å±¥æ­´',
          ),
        ],
      ),
      body: SingleChildScrollView(
        controller: _scrollController,
        child: Column(
          children: [
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            if (mealPlanAsync.hasError)
            Container(
              margin: const EdgeInsets.all(16),
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: _baseColor.withOpacity(0.8),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: _primaryColor.withOpacity(0.5),
                ),
              ),
              child: Row(
                children: [
                  Icon(
                    Icons.error_outline,
                    color: _accentColor,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'çŒ®ç«‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${mealPlanAsync.error}',
                      style: TextStyle(
                        color: _textColor,
                      ),
                    ),
                  ),
                  TextButton(
                    onPressed: _suggestMealPlan,
                    style: TextButton.styleFrom(
                      foregroundColor: _primaryColor,
                    ),
                    child: const Text('å†è©¦è¡Œ'),
                  ),
                ],
              ),
            ),

            // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            mealPlanAsync.when(
              data: (mealPlan) => mealPlan != null
                  ? (_isInitialLoading ? _buildLoadingWithMealPlan(mealPlan) : _buildMealPlanContent(mealPlan))
                  : _buildEmptyState(),
              loading: () => _buildLoadingState(),
              error: (error, stack) => _buildErrorState(error),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMealPlanContent(MealPlan mealPlan) {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // çŒ®ç«‹ãƒ˜ãƒƒãƒ€ãƒ¼
          _buildMealPlanHeader(mealPlan),

          const SizedBox(height: 24),

          // çŒ®ç«‹ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚‚å«ã‚€ï¼‰
          _buildMealPlanCards(mealPlan),

          const SizedBox(height: 24),

          // ææ–™æƒ…å ±
          _buildIngredientsInfo(mealPlan),

          const SizedBox(height: 24),

          // è²·ã„ç‰©ãƒªã‚¹ãƒˆ
          if (mealPlan.hasShoppingList)
            Container(
              key: _shoppingListKey,
              child: _buildShoppingListSection(mealPlan),
            ),
        ],
      ),
    );
  }

  Widget _buildMealPlanHeader(MealPlan mealPlan) {

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            _baseColor.withOpacity(0.8),
            _baseColor.withOpacity(0.6),
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: _primaryColor.withOpacity(0.4),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.restaurant_menu,
                color: _textColor,
                size: 28,
              ),
              const SizedBox(width: 12),
              Text(
                'ä»Šæ—¥ã®çŒ®ç«‹',
                style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                  fontWeight: FontWeight.bold,
                  color: _textColor,
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),


          Row(
            children: [
              _buildInfoChip(
                icon: Icons.access_time,
                label: '${mealPlan.totalCookingTime}åˆ†',
                opacity: 0.9,
              ),
              const SizedBox(width: 12),
              _buildInfoChip(
                icon: Icons.star,
                label: mealPlan.difficultyDisplayName,
                opacity: 0.8,
              ),
              const SizedBox(width: 12),
              _buildInfoChip(
                icon: Icons.favorite,
                label: '${mealPlan.nutritionScore.toInt()}ç‚¹',
                opacity: 0.7,
              ),
            ],
          ),

          const SizedBox(height: 12),

          // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º
          if (mealPlan.popularityScore != null || mealPlan.cookingFrequency != null)
            Row(
              children: [
                if (mealPlan.popularityScore != null) ...[
                  _buildInfoChip(
                    icon: Icons.trending_up,
                    label: mealPlan.popularityDisplayName,
                    opacity: 0.6,
                  ),
                  const SizedBox(width: 12),
                ],
                if (mealPlan.cookingFrequency != null) ...[
                  _buildInfoChip(
                    icon: Icons.schedule,
                    label: mealPlan.cookingFrequencyDisplayName,
                    opacity: 0.5,
                  ),
                  const SizedBox(width: 12),
                ],
                if (mealPlan.seasonalRelevance != null && mealPlan.seasonalRelevance != 'all') ...[
                  _buildInfoChip(
                    icon: Icons.wb_sunny,
                    label: mealPlan.seasonalRelevanceDisplayName,
                    opacity: 0.4,
                  ),
                ],
            ],
          ),

          const SizedBox(height: 12),

          // ä¿¡é ¼åº¦è¡¨ç¤º
          Row(
            children: [
              Icon(
                Icons.psychology,
                size: 16,
                color: _accentColor.withOpacity(0.8),
              ),
              const SizedBox(width: 4),
              Text(
                'ä¿¡é ¼åº¦: ${(mealPlan.confidence * 100).toInt()}%',
                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                  color: _accentColor.withOpacity(0.8),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }


  Widget _buildInfoChip({
    required IconData icon,
    required String label,
    required double opacity,
  }) {
    final chipColor = _primaryColor.withOpacity(opacity);
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: _baseColor.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: chipColor.withOpacity(0.6)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: chipColor),
          const SizedBox(width: 4),
          Text(
            label,
            style: TextStyle(
              color: _textColor,
              fontWeight: FontWeight.w500,
              fontSize: 12,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMealPlanCards(MealPlan mealPlan) {
    return Column(
      children: [
        // 2x2ã®æ­£æ–¹å½¢ãƒ–ãƒ­ãƒƒã‚¯ã‚°ãƒªãƒƒãƒ‰ï¼ˆä¸»èœã€å‰¯èœã€æ±ç‰©ã€ã‚‚ã†ä¸€å“ãƒœã‚¿ãƒ³ï¼‰
        Row(
          children: [
            Expanded(
              child: AspectRatio(
                aspectRatio: 1.0,
                child: MealPlanSquareCard(
                  mealItem: mealPlan.mainDish,
                  title: 'ä¸»èœ',
                  imageUrl: _mealImages['mainDish'],
                  onTap: () => _showMealDetail(context, mealPlan.mainDish),
                ),
              ),
            ),
            SizedBox(width: 12),
            Expanded(
              child: AspectRatio(
                aspectRatio: 1.0,
                child: MealPlanSquareCard(
                  mealItem: mealPlan.sideDish,
                  title: 'å‰¯èœ',
                  imageUrl: _mealImages['sideDish'],
                  onTap: () => _showMealDetail(context, mealPlan.sideDish),
                ),
              ),
            ),
          ],
        ),
        SizedBox(height: 12),
        Row(
          children: [
            Expanded(
              child: AspectRatio(
                aspectRatio: 1.0,
                child: MealPlanSquareCard(
                  mealItem: mealPlan.soup,
                  title: 'æ±ç‰©',
                  imageUrl: _mealImages['soup'],
                  onTap: () => _showMealDetail(context, mealPlan.soup),
                ),
              ),
            ),
            SizedBox(width: 12),
            Expanded(
              child: AspectRatio(
                aspectRatio: 1.0,
                child: MealPlanSquareCard(
                  title: 'ã‚‚ã†ä¸€å“',
                  isAddButton: true,
                  onTap: () => _suggestAdditionalDish(mealPlan),
                ),
              ),
            ),
          ],
        ),

        const SizedBox(height: 24),

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
        _buildActionButtons(mealPlan),
      ],
    );
  }

  Widget _buildActionButtons(MealPlan mealPlan) {
    return Row(
      children: [
        Expanded(
          child: OutlinedButton(
            onPressed: _isGeneratingImages ? null : () => _suggestMealPlan(),
            style: OutlinedButton.styleFrom(
              foregroundColor: _textColor,
              side: BorderSide(color: _secondaryColor.withOpacity(0.6)),
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: _isGeneratingImages
                ? Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      SizedBox(
                        width: 16,
                        height: 16,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          color: _accentColor,
                        ),
                      ),
                      const SizedBox(width: 8),
                      const Text('ä½œæˆä¸­...'),
                    ],
                  )
                : const Text('å†ææ¡ˆ'),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: ElevatedButton(
            onPressed: () {
              print('ğŸ”˜ çŒ®ç«‹æ±ºå®šãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
              _showMealDecisionConfirmation(mealPlan);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: _primaryColor,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
              elevation: 2,
            ),
            child: const Text(
              'çŒ®ç«‹ã‚’æ±ºå®š',
              style: TextStyle(fontWeight: FontWeight.bold),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildShoppingListSection(MealPlan mealPlan) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: _baseColor.withOpacity(0.6),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: _primaryColor.withOpacity(0.4),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.shopping_cart,
                color: _textColor,
                size: 24,
              ),
              const SizedBox(width: 8),
              Text(
                'è²·ã„ç‰©ãƒªã‚¹ãƒˆ',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                  color: _textColor,
                ),
              ),
              const Spacer(),
              if (mealPlan.estimatedTotalCost > 0)
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: _primaryColor.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    'æ¦‚ç®—: ${mealPlan.estimatedTotalCost.toInt()}å††',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  ),
                ),
            ],
          ),

          const SizedBox(height: 16),

          // è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ 
          ...mealPlan.shoppingList!.map((item) => _buildShoppingListItem(item)),

          const SizedBox(height: 16),

          // è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’Firestoreã«ä¿å­˜ã™ã‚‹ãƒœã‚¿ãƒ³
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: () => _saveShoppingList(mealPlan),
              icon: const Icon(Icons.save),
              label: const Text('è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä¿å­˜'),
              style: ElevatedButton.styleFrom(
                backgroundColor: _primaryColor,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
                elevation: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildShoppingListItem(ShoppingItem item) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.8),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: _secondaryColor.withOpacity(0.3),
        ),
      ),
      child: Row(
        children: [
          Icon(
            Icons.shopping_basket,
            color: _accentColor,
            size: 20,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  item.name,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.w500,
                    color: _textColor,
                  ),
                ),
                if (item.notes.isNotEmpty)
                  Text(
                    item.notes,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: _accentColor.withOpacity(0.8),
                    ),
                  ),
              ],
            ),
          ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: _primaryColor.withOpacity(0.3),
              borderRadius: BorderRadius.circular(6),
            ),
            child: Text(
              '${item.quantity}${item.unit}',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.w500,
                fontSize: 12,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildIngredientsInfo(MealPlan mealPlan) {
    final missingIngredients = mealPlan.missingIngredients;
    final expiringIngredients = mealPlan.expiringIngredients;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'ææ–™æƒ…å ±',
          style: Theme.of(context).textTheme.titleLarge?.copyWith(
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 12),

        if (expiringIngredients.isNotEmpty) ...[
          _buildIngredientSection(
            title: 'è³å‘³æœŸé™ãŒè¿‘ã„é£Ÿæ',
            ingredients: expiringIngredients,
            opacity: 0.9,
            icon: Icons.warning,
          ),
          const SizedBox(height: 12),
        ],

        if (missingIngredients.isNotEmpty) ...[
          _buildIngredientSection(
            title: 'è²·ã„ç‰©ãŒå¿…è¦ãªé£Ÿæ',
            ingredients: missingIngredients,
            opacity: 0.8,
            icon: Icons.shopping_cart,
          ),
          const SizedBox(height: 12),
        ],

        _buildIngredientSection(
          title: 'åˆ©ç”¨å¯èƒ½ãªé£Ÿæ',
          ingredients: mealPlan.mainDish.ingredients
              .where((ingredient) => ingredient.available)
              .toList(),
          opacity: 0.7,
          icon: Icons.check_circle,
        ),
      ],
    );
  }

  Widget _buildIngredientSection({
    required String title,
    required List<Ingredient> ingredients,
    required double opacity,
    required IconData icon,
  }) {
    final sectionColor = _primaryColor.withOpacity(opacity);
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: _baseColor.withOpacity(0.5),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: sectionColor.withOpacity(0.5)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(icon, color: sectionColor, size: 20),
              const SizedBox(width: 8),
              Text(
                title,
                style: TextStyle(
                  color: _textColor,
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Wrap(
            spacing: 8,
            runSpacing: 4,
            children: ingredients.map((ingredient) {
              return Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: sectionColor.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  ingredient.displayName,
                  style: TextStyle(
                    color: _textColor,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              );
            }).toList(),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return Container(
      height: MediaQuery.of(context).size.height * 0.6,
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.restaurant_menu,
              size: 80,
              color: Colors.grey[400],
            ),
            const SizedBox(height: 16),
            Text(
              'çŒ®ç«‹ã‚’ææ¡ˆã—ã¾ã™',
              style: TextStyle(
                fontSize: 18,
                color: Colors.grey[600],
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'å†·è”µåº«ã®é£Ÿæã‚’åˆ†æã—ã¦\næœ€é©ãªçŒ®ç«‹ã‚’ææ¡ˆã—ã¾ã™',
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[500],
              ),
            ),
            const SizedBox(height: 24),
            ElevatedButton.icon(
              onPressed: _suggestMealPlan,
              icon: const Icon(Icons.auto_awesome),
              label: const Text('çŒ®ç«‹ã‚’ææ¡ˆ'),
              style: ElevatedButton.styleFrom(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Container(
      height: MediaQuery.of(context).size.height * 0.6,
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            CircularProgressIndicator(
              color: _primaryColor,
              strokeWidth: 3,
            ),
            const SizedBox(height: 24),
            Text(
              'AIãŒçŒ®ç«‹ã‚’ä½œæˆä¸­...',
              style: TextStyle(
                fontSize: 18,
                color: _textColor,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLoadingWithMealPlan(MealPlan mealPlan) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.6,
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            CircularProgressIndicator(
              color: _primaryColor,
              strokeWidth: 3,
            ),
            const SizedBox(height: 24),
            Text(
              'AIãŒçŒ®ç«‹ç”»åƒã‚’ä½œæˆä¸­...',
              style: TextStyle(
                fontSize: 18,
                color: _textColor,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildErrorState(Object error) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.6,
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 80,
              color: Colors.red[400],
            ),
            const SizedBox(height: 16),
            Text(
              'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
              style: TextStyle(
                fontSize: 18,
                color: Colors.red[600],
              ),
            ),
            const SizedBox(height: 8),
            Text(
              error.toString(),
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[500],
              ),
            ),
            const SizedBox(height: 24),
            ElevatedButton.icon(
              onPressed: _suggestMealPlan,
              icon: const Icon(Icons.refresh),
              label: const Text('å†è©¦è¡Œ'),
              style: ElevatedButton.styleFrom(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _suggestMealPlan() async {
    print('ğŸ½ï¸ MealPlanScreen: çŒ®ç«‹ææ¡ˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
    // TODO: å®Ÿéš›ã®householdIdã‚’å–å¾—
    const householdId = 'default_household';
    print('   ä¸–å¸¯ID: $householdId');

    setState(() {
      _isInitialLoading = true;
    });

    try {
      // çŒ®ç«‹ã‚’ææ¡ˆ
      await ref.read(mealPlanProvider.notifier).suggestMealPlan(householdId: householdId);

      // çŒ®ç«‹ãŒç”Ÿæˆã•ã‚ŒãŸã‚‰ç”»åƒã‚’ç”Ÿæˆ
      final mealPlan = ref.read(mealPlanProvider).value;
      if (mealPlan != null) {
        await _generateMealImages(mealPlan);
      }
    } finally {
      setState(() {
        _isInitialLoading = false;
      });
    }
  }


  Future<void> _generateMealImages(MealPlan mealPlan) async {
    // å³åº§ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’è¨­å®šï¼ˆä¸»é£Ÿã‚’é™¤ã3å“ï¼‰
    setState(() {
      _mealImages = {
        'mainDish': null,
        'sideDish': null,
        'soup': null,
      };
      _isGeneratingImages = true;
    });

    try {
      // ã‚·ãƒ³ãƒ—ãƒ«ãªç”»åƒç”ŸæˆAPIã‚’å‘¼ã³å‡ºã—
      final adkApiClient = ADKApiClient.forSimpleImageApi();

      // ä¸¦åˆ—ã§ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œï¼ˆä¸»é£Ÿã‚’é™¤ã3å“ã®ã¿ï¼‰
      final futures = [
        _generateImageViaADKWithTimeout(
          adkApiClient,
          mealPlan.mainDish.name,
          mealPlan.mainDish.description,
          180, // 3åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        ),
        _generateImageViaADKWithTimeout(
          adkApiClient,
          mealPlan.sideDish.name,
          mealPlan.sideDish.description,
          180,
        ),
        _generateImageViaADKWithTimeout(
          adkApiClient,
          mealPlan.soup.name,
          mealPlan.soup.description,
          180,
        ),
      ];

      // ä¸¦åˆ—å®Ÿè¡Œã§çµæœã‚’å¾…ã¤
      final results = await Future.wait(futures);

      setState(() {
        _mealImages = {
          'mainDish': results[0],
          'sideDish': results[1],
          'soup': results[2],
        };
        _isGeneratingImages = false;
      });

      print('âœ… çŒ®ç«‹ç”»åƒç”Ÿæˆå®Œäº†');
      print('   ä¸»èœç”»åƒ: ${results.length > 0 ? results[0] : "null"}');
      print('   å‰¯èœç”»åƒ: ${results.length > 1 ? results[1] : "null"}');
      print('   æ±ç‰©ç”»åƒ: ${results.length > 2 ? results[2] : "null"}');
    } catch (e) {
      print('âŒ çŒ®ç«‹ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: $e');
      setState(() {
        _isGeneratingImages = false;
      });
    }
  }

  /// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã®ç”»åƒç”Ÿæˆ
  Future<String?> _generateImageViaADKWithTimeout(
    ADKApiClient adkApiClient,
    String dishName,
    String description,
    int timeoutSeconds,
  ) async {
    try {
      print('ğŸ–¼ï¸ ç”»åƒç”Ÿæˆé–‹å§‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${timeoutSeconds}ç§’ï¼‰: $dishName');

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œ
      final response = await adkApiClient.generateImage(
        prompt: '$dishName: $description',
        style: 'photorealistic',
        size: '1024x1024',
      ).timeout(Duration(seconds: timeoutSeconds));

      if (response != null && response['image_url'] != null) {
        final imageUrl = response['image_url'] as String;
        print('âœ… ç”»åƒç”Ÿæˆå®Œäº†: $dishName');
        print('   ç”»åƒURL: $imageUrl');
        return imageUrl;
      } else {
        print('âš ï¸ ç”»åƒç”Ÿæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©º: $dishName');
        return _getFallbackImageUrl(dishName);
      }
    } catch (e) {
      print('âŒ ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰: $dishName - $e');
      return _getFallbackImageUrl(dishName);
    }
  }

  /// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒURLã‚’å–å¾—
  String _getFallbackImageUrl(String dishName) {
    final dishLower = dishName.toLowerCase();

    // æ–™ç†ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ
    if (dishLower.contains('ç‚’ã‚') || dishLower.contains('ç„¼ã')) {
      return 'https://images.unsplash.com/photo-1559847844-5315695dadae?w=512&h=512&fit=crop';
    } else if (dishLower.contains('ç…®') || dishLower.contains('ç…®ç‰©')) {
      return 'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=512&h=512&fit=crop';
    } else if (dishLower.contains('ã‚µãƒ©ãƒ€') || dishLower.contains('é‡èœ')) {
      return 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=512&h=512&fit=crop';
    } else if (dishLower.contains('æ±ç‰©') || dishLower.contains('ã‚¹ãƒ¼ãƒ—') || dishLower.contains('å‘³å™Œæ±')) {
      return 'https://images.unsplash.com/photo-1547592180-85f173990554?w=512&h=512&fit=crop';
    } else if (dishLower.contains('è‚‰') || dishLower.contains('è±š') || dishLower.contains('é¶')) {
      return 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?w=512&h=512&fit=crop';
    } else if (dishLower.contains('é­š') || dishLower.contains('é®­') || dishLower.contains('é¯–')) {
      return 'https://images.unsplash.com/photo-1544943910-4c1dc44aab44?w=512&h=512&fit=crop';
    } else {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ–™ç†ç”»åƒ
      return 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=512&h=512&fit=crop';
    }
  }

  void _showMealDecisionConfirmation(MealPlan mealPlan) {
    print('ğŸ½ï¸ _showMealDecisionConfirmation called');
    print('ğŸ“‹ MealPlan: ${mealPlan.displayName}');
    
    // ä½¿ç”¨ã™ã‚‹é£Ÿæã‚’æŠ½å‡ºï¼ˆé‡ã‚‚å«ã‚€ï¼‰
    final allIngredients = <Ingredient>[];
    allIngredients.addAll(mealPlan.mainDish.ingredients);
    allIngredients.addAll(mealPlan.sideDish.ingredients);
    allIngredients.addAll(mealPlan.soup.ingredients);
    
    print('ğŸ¥¬ Total ingredients: ${allIngredients.length}');
    for (final ingredient in allIngredients) {
      print('   - ${ingredient.name} ${ingredient.quantity ?? 'é©é‡'}');
    }

    // é£ŸæãŒãªã„å ´åˆã®å‡¦ç†
    if (allIngredients.isEmpty) {
      print('âš ï¸ No ingredients found in meal plan');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('çŒ®ç«‹ã«é£Ÿææƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    print('ğŸ’¬ Showing confirmation dialog...');
    
    try {
      showDialog(
        context: context,
        builder: (context) {
          print('ğŸ—ï¸ Building AlertDialog...');
          return AlertDialog(
          backgroundColor: _baseColor,
        title: Text(
          'ã“ã®çŒ®ç«‹ã§æ±ºå®šã—ã¾ã™ã‹ï¼Ÿ',
          style: TextStyle(
            color: _textColor,
            fontWeight: FontWeight.bold,
          ),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'ä»¥ä¸‹ã®é£Ÿæã‚’ä½¿ç”¨ã—ã¾ã™ï¼š',
              style: TextStyle(color: _accentColor),
            ),
            SizedBox(height: 8),
            Container(
              height: 150,
              child: ListView.builder(
                itemCount: allIngredients.length,
                itemBuilder: (context, index) => Padding(
                  padding: EdgeInsets.symmetric(vertical: 2),
                  child: Row(
                    children: [
                      Icon(Icons.restaurant, 
                           color: _accentColor, size: 16),
                      SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          '${allIngredients[index].name} ${allIngredients[index].quantity ?? 'é©é‡'}',
                          style: TextStyle(color: _textColor),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            child: Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«', style: TextStyle(color: _accentColor)),
            onPressed: () => Navigator.of(context).pop(),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: _primaryColor,
              foregroundColor: Colors.white,
            ),
            child: Text('æ±ºå®š'),
            onPressed: () {
              Navigator.of(context).pop();
              _executeMealDecision(mealPlan);
            },
          ),
        ],
          );
        },
      );
    } catch (e) {
      print('âŒ Error showing dialog: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Future<void> _executeMealDecision(MealPlan mealPlan) async {
    try {
      // é£Ÿæä½¿ç”¨é‡æ¸›å°‘ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
      final appState = ref.read(appStateProvider);
      final allIngredients = <Ingredient>[];
      allIngredients.addAll(mealPlan.mainDish.ingredients);
      allIngredients.addAll(mealPlan.sideDish.ingredients);
      allIngredients.addAll(mealPlan.soup.ingredients);

      int reducedCount = 0;
      
      // å†·è”µåº«ã®å•†å“ã‹ã‚‰è©²å½“é£Ÿæã®æ•°é‡ã‚’æ¸›ã‚‰ã™
      for (final ingredient in allIngredients) {
        final matchingProducts = appState.products.where(
          (product) => product.name.contains(ingredient.name) ||
                      ingredient.name.contains(product.name)
        ).toList();

        for (final product in matchingProducts) {
          if (product.id != null && product.quantity > 0) {
            // ä½¿ç”¨ã™ã‚‹é‡ã‚’è¨ˆç®—ï¼ˆæœ€å°1ã€æœ€å¤§ç¾åœ¨ã®æ•°é‡ï¼‰
            final usageAmount = _calculateUsageAmount(ingredient, product);
            final newQuantity = (product.quantity - usageAmount).clamp(0, product.quantity);
            
            if (newQuantity == 0) {
              // æ•°é‡ãŒ0ã«ãªã‚‹å ´åˆã¯å‰Šé™¤
              await ref.read(appStateProvider.notifier)
                        .deleteProductFromFirebase(product.id!);
            } else {
              // æ•°é‡ã‚’æ¸›ã‚‰ã™
              final updatedProduct = product.copyWith(quantity: newQuantity);
              await ref.read(appStateProvider.notifier)
                        .updateProductInFirebase(updatedProduct);
            }
            reducedCount++;
            break; // åŒã˜é£Ÿæã¯1ã¤ã ã‘å‡¦ç†
          }
        }
      }

      // çŒ®ç«‹æ‰¿èªå‡¦ç†
      if (mealPlan.id != null) {
        await ref.read(mealPlanProvider.notifier).acceptMealPlan(mealPlan.id!);
      }

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('çŒ®ç«‹ãŒæ±ºå®šã•ã‚Œã¾ã—ãŸã€‚${reducedCount}å€‹ã®é£Ÿæã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚'),
            backgroundColor: Colors.green,
            action: SnackBarAction(
              label: 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ',
              textColor: Colors.white,
              onPressed: () => _generateShoppingList(mealPlan),
            ),
          ),
        );
      }
    } catch (e) {
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('é£Ÿæã®ä½¿ç”¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  // é£Ÿæã®ä½¿ç”¨é‡ã‚’è¨ˆç®—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  int _calculateUsageAmount(Ingredient ingredient, dynamic product) {
    // ãƒ¬ã‚·ãƒ”ã®åˆ†é‡ã‹ã‚‰ä½¿ç”¨é‡ã‚’æ¨å®š
    final quantity = ingredient.quantity?.toLowerCase() ?? '';
    
    if (quantity.contains('å€‹') || quantity.contains('æœ¬') || quantity.contains('æš')) {
      // å€‹æ•°å˜ä½ã®å ´åˆ
      final match = RegExp(r'(\d+)').firstMatch(quantity);
      if (match != null) {
        return int.tryParse(match.group(1)!) ?? 1;
      }
      return 1;
    } else if (quantity.contains('g') || quantity.contains('ml')) {
      // é‡é‡ãƒ»å®¹é‡å˜ä½ã®å ´åˆã¯ç¾åœ¨ã®æ•°é‡ã®åŠåˆ†ã‚’ä½¿ç”¨
      return (product.quantity * 0.5).ceil().clamp(1, product.quantity);
    } else {
      // ãã®ä»–ã®å ´åˆã¯1å€‹ä½¿ç”¨
      return 1;
    }
  }

  void _showReSuggestConfirmation() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: _baseColor,
        title: Text(
          'çŒ®ç«‹ã‚’å†ææ¡ˆã—ã¾ã™ã‹ï¼Ÿ',
          style: TextStyle(
            color: _textColor,
            fontWeight: FontWeight.bold,
          ),
        ),
        content: Text(
          'ç¾åœ¨ã®çŒ®ç«‹ãŒæ–°ã—ã„ææ¡ˆã«ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚',
          style: TextStyle(color: _accentColor),
        ),
        actions: [
          TextButton(
            child: Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«', style: TextStyle(color: _accentColor)),
            onPressed: () => Navigator.of(context).pop(),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: _primaryColor,
              foregroundColor: Colors.white,
            ),
            child: Text('å†ææ¡ˆ'),
            onPressed: () {
              Navigator.of(context).pop();
              _suggestMealPlan();
            },
          ),
        ],
      ),
    );
  }



  void _showMealDetail(BuildContext context, MealItem mealItem) {
    showDialog(
      context: context,
      builder: (context) => MealDetailDialog(mealItem: mealItem),
    );
  }

  void _showMealPlanHistory(BuildContext context) {
    // TODO: çŒ®ç«‹å±¥æ­´ç”»é¢ã‚’å®Ÿè£…
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('çŒ®ç«‹å±¥æ­´æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™'),
      ),
    );
  }

  void _generateShoppingList(MealPlan mealPlan) {
    // TODO: è²·ã„ç‰©ãƒªã‚¹ãƒˆç”Ÿæˆæ©Ÿèƒ½ã‚’å®Ÿè£…
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('è²·ã„ç‰©ãƒªã‚¹ãƒˆç”Ÿæˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™'),
      ),
    );
  }

  void _suggestAdditionalDish(MealPlan mealPlan) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: _baseColor,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
        title: Text(
          'ã‚‚ã†ä¸€å“è¿½åŠ ',
          style: TextStyle(
            color: _textColor,
            fontWeight: FontWeight.bold,
            fontSize: 20,
          ),
          textAlign: TextAlign.center,
        ),
        content: Container(
          width: double.maxFinite,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'ã©ã®ã‚ˆã†ãªæ–™ç†ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ',
                style: TextStyle(color: _accentColor, fontSize: 14),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: 16),
              _buildDishOption(
                title: 'å‰¯èœ',
                subtitle: 'é‡èœã‚„ã‚µãƒ©ãƒ€ãªã©',
                icon: Icons.eco,
                onTap: () => _addAdditionalDish('å‰¯èœ'),
              ),
              SizedBox(height: 8),
              _buildDishOption(
                title: 'æ±ç‰©',
                subtitle: 'ã‚¹ãƒ¼ãƒ—ã‚„å‘³å™Œæ±ãªã©',
                icon: Icons.local_drink,
                onTap: () => _addAdditionalDish('æ±ç‰©'),
              ),
              SizedBox(height: 8),
              _buildDishOption(
                title: 'ãŠã¤ã¾ã¿',
                subtitle: 'ç°¡å˜ãªä¸€å“æ–™ç†',
                icon: Icons.local_bar,
                onTap: () => _addAdditionalDish('ãŠã¤ã¾ã¿'),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            child: Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«', style: TextStyle(color: _accentColor)),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ],
      ),
    );
  }

  Widget _buildDishOption({
    required String title,
    required String subtitle,
    required IconData icon,
    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8),
      child: Container(
        padding: EdgeInsets.all(12),
        decoration: BoxDecoration(
          border: Border.all(color: _primaryColor.withOpacity(0.3)),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Row(
          children: [
            Container(
              padding: EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: _primaryColor.withOpacity(0.2),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: _accentColor, size: 24),
            ),
            SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      color: _textColor,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: _accentColor,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            Icon(Icons.arrow_forward_ios,
                 color: _accentColor, size: 16),
          ],
        ),
      ),
    );
  }

  Future<void> _addAdditionalDish(String dishType) async {
    Navigator.of(context).pop();

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: _baseColor,
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            CircularProgressIndicator(color: _primaryColor),
            SizedBox(height: 16),
            Text(
              '${dishType}ã‚’è€ƒãˆã¦ã„ã¾ã™...',
              style: TextStyle(color: _textColor),
            ),
          ],
        ),
      ),
    );

    try {
      // ä»®ã®å‡¦ç†ï¼ˆå°†æ¥çš„ã«AIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆï¼‰
      await Future.delayed(Duration(seconds: 2));

      Navigator.of(context).pop(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‰ã˜ã‚‹

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('${dishType}ã®ææ¡ˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™'),
          backgroundColor: _primaryColor,
        ),
      );
    } catch (e) {
      Navigator.of(context).pop(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‰ã˜ã‚‹
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('æ–™ç†ã®ææ¡ˆã«å¤±æ•—ã—ã¾ã—ãŸ'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _scrollToShoppingList() {
    final RenderBox? renderBox = _shoppingListKey.currentContext
        ?.findRenderObject() as RenderBox?;

    if (renderBox != null) {
      final position = renderBox.localToGlobal(Offset.zero);
      final screenHeight = MediaQuery.of(context).size.height;

      _scrollController.animateTo(
        position.dy - (screenHeight * 0.1), // ä¸Šéƒ¨ã«å°‘ã—ä½™ç™½
        duration: Duration(milliseconds: 800),
        curve: Curves.easeInOut,
      );
    }
  }

  void _saveShoppingList(MealPlan mealPlan) async {
    if (mealPlan.shoppingList == null || mealPlan.shoppingList!.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('è²·ã„ç‰©ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    try {
      // è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ä¿å­˜
      await ref.read(shoppingListProvider.notifier).generateShoppingList(mealPlan);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ${mealPlan.shoppingList!.length}å“ç›®ï¼‰'),
            backgroundColor: Colors.green,
            action: SnackBarAction(
              label: 'ç¢ºèª',
              textColor: Colors.white,
              onPressed: () {
                // è²·ã„ç‰©ãƒªã‚¹ãƒˆç”»é¢ã«é·ç§»ï¼ˆå®Ÿè£…äºˆå®šï¼‰
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('è²·ã„ç‰©ãƒªã‚¹ãƒˆç”»é¢ã¯æº–å‚™ä¸­ã§ã™'),
                  ),
                );
              },
            ),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('è²·ã„ç‰©ãƒªã‚¹ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }
}
