# 🔧 gcloud CLI 環境変数設定ガイド

## 概要
gcloud CLIを使用してGCP/Firebaseの認証情報と環境変数を自動的に取得・設定する方法

## 🚀 gcloud CLI から取得可能な情報

### 1. プロジェクト情報
```bash
# 現在のプロジェクトID
gcloud config get-value project
# 出力例: gcp-f06-barcode

# プロジェクトの詳細情報
gcloud projects describe $(gcloud config get-value project) --format=json

# プロジェクト番号
gcloud projects describe $(gcloud config get-value project) --format="value(projectNumber)"
```

### 2. Firebase設定の取得
```bash
# Firebase プロジェクト設定を取得
firebase apps:sdkconfig web

# 出力例（JSON形式）:
# {
#   "apiKey": "AIzaSy...",
#   "authDomain": "gcp-f06-barcode.firebaseapp.com",
#   "projectId": "gcp-f06-barcode",
#   "storageBucket": "gcp-f06-barcode.appspot.com",
#   "messagingSenderId": "762195307431",
#   "appId": "1:762195307431:web:..."
# }

# iOS設定
firebase apps:sdkconfig ios

# Android設定
firebase apps:sdkconfig android
```

### 3. サービスアカウントキーの生成
```bash
# サービスアカウント作成
gcloud iam service-accounts create flutter-app-sa \
  --display-name="Flutter App Service Account"

# サービスアカウントにロール付与
gcloud projects add-iam-policy-binding $(gcloud config get-value project) \
  --member="serviceAccount:flutter-app-sa@$(gcloud config get-value project).iam.gserviceaccount.com" \
  --role="roles/firebase.admin"

# キーファイル生成
gcloud iam service-accounts keys create service-account-key.json \
  --iam-account=flutter-app-sa@$(gcloud config get-value project).iam.gserviceaccount.com
```

### 4. API キーの取得
```bash
# APIキー一覧
gcloud services api-keys list --format=json

# 特定のAPIキー詳細
gcloud services api-keys describe <KEY_ID> --format=json

# 新しいAPIキー作成
gcloud services api-keys create \
  --display-name="Flutter App API Key" \
  --format=json
```

## 🔐 自動環境変数設定スクリプト

### `scripts/setup_env.sh`
```bash
#!/bin/bash

# プロジェクトIDを取得
PROJECT_ID=$(gcloud config get-value project)
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")
REGION="asia-northeast1"

# Firebase設定を取得
echo "Fetching Firebase configuration..."
FIREBASE_CONFIG=$(firebase apps:sdkconfig web --json)

# JSONから値を抽出
API_KEY=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.apiKey')
AUTH_DOMAIN=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.authDomain')
STORAGE_BUCKET=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.storageBucket')
MESSAGING_SENDER_ID=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.messagingSenderId')
APP_ID=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.appId')

# .envファイル生成
cat > .env << EOF
# Auto-generated by setup_env.sh
# Generated at: $(date)

# GCP Configuration
GCP_PROJECT_ID=$PROJECT_ID
GCP_PROJECT_NUMBER=$PROJECT_NUMBER
GCP_REGION=$REGION

# Firebase Configuration
FIREBASE_API_KEY=$API_KEY
FIREBASE_AUTH_DOMAIN=$AUTH_DOMAIN
FIREBASE_PROJECT_ID=$PROJECT_ID
FIREBASE_STORAGE_BUCKET=$STORAGE_BUCKET
FIREBASE_MESSAGING_SENDER_ID=$MESSAGING_SENDER_ID
FIREBASE_APP_ID=$APP_ID

# Vertex AI
VERTEX_AI_PROJECT=$PROJECT_ID
VERTEX_AI_LOCATION=$REGION
VERTEX_AI_ENDPOINT=$REGION-aiplatform.googleapis.com

# Service Account
GOOGLE_APPLICATION_CREDENTIALS=./service-account-key.json
EOF

echo "✅ .env file created successfully!"
```

### `scripts/setup_dart_env.sh`
```bash
#!/bin/bash

# Dart用の環境変数ファイルを生成
PROJECT_ID=$(gcloud config get-value project)

# Firebase設定を取得
FIREBASE_CONFIG=$(firebase apps:sdkconfig web --json)

# 値を抽出
API_KEY=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.apiKey')
AUTH_DOMAIN=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.authDomain')
STORAGE_BUCKET=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.storageBucket')
MESSAGING_SENDER_ID=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.messagingSenderId')
APP_ID=$(echo $FIREBASE_CONFIG | jq -r '.result.sdkConfig.appId')

# Dart環境変数ファイル生成
cat > lib/core/config/env.dart << EOF
// Auto-generated by setup_dart_env.sh
// DO NOT COMMIT THIS FILE

class Env {
  static const String gcpProjectId = '$PROJECT_ID';
  static const String firebaseApiKey = '$API_KEY';
  static const String firebaseAuthDomain = '$AUTH_DOMAIN';
  static const String firebaseStorageBucket = '$STORAGE_BUCKET';
  static const String firebaseMessagingSenderId = '$MESSAGING_SENDER_ID';
  static const String firebaseAppId = '$APP_ID';
  
  // These need to be set manually or from other sources
  static const String geminiApiKey = String.fromEnvironment('GEMINI_API_KEY', defaultValue: '');
  static const String vapidKey = String.fromEnvironment('VAPID_KEY', defaultValue: '');
}
EOF

echo "✅ lib/core/config/env.dart created successfully!"
```

## 🎯 Gemini API キーの取得

Gemini APIキーはgcloud CLIでは直接取得できないため、別途取得が必要：

```bash
# 1. ブラウザでGoogle AI Studioを開く
open https://makersuite.google.com/app/apikey

# 2. 環境変数として設定
export GEMINI_API_KEY="your-api-key-here"

# 3. .envファイルに追加
echo "GEMINI_API_KEY=$GEMINI_API_KEY" >> .env
```

## 🔄 Application Default Credentials (ADC)

```bash
# ADCを設定（ローカル開発用）
gcloud auth application-default login

# ADCの場所を確認
echo $GOOGLE_APPLICATION_CREDENTIALS
# または
gcloud auth application-default print-access-token

# Flutterアプリで使用
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/.config/gcloud/application_default_credentials.json"
```

## 📱 iOS/Android用設定の取得

### iOS
```bash
# iOS用のGoogleService-Info.plistをダウンロード
firebase apps:sdkconfig ios --out ios/Runner/GoogleService-Info.plist

# または手動でダウンロード
curl -o ios/Runner/GoogleService-Info.plist \
  "https://firebase.googleapis.com/v1/projects/$PROJECT_ID/iosApps/<APP_ID>/config"
```

### Android
```bash
# Android用のgoogle-services.jsonをダウンロード
firebase apps:sdkconfig android --out android/app/google-services.json

# または手動でダウンロード
curl -o android/app/google-services.json \
  "https://firebase.googleapis.com/v1/projects/$PROJECT_ID/androidApps/<APP_ID>/config"
```

## 🐳 Docker環境での使用

```dockerfile
# Dockerfile
FROM google/cloud-sdk:alpine

# gcloud認証情報をコピー
COPY service-account-key.json /app/
ENV GOOGLE_APPLICATION_CREDENTIALS=/app/service-account-key.json

# または、ビルド時に環境変数として渡す
ARG GCP_PROJECT_ID
ARG FIREBASE_API_KEY
ENV GCP_PROJECT_ID=$GCP_PROJECT_ID
ENV FIREBASE_API_KEY=$FIREBASE_API_KEY
```

```bash
# Docker buildで環境変数を渡す
docker build \
  --build-arg GCP_PROJECT_ID=$(gcloud config get-value project) \
  --build-arg FIREBASE_API_KEY=$(firebase apps:sdkconfig web --json | jq -r '.result.sdkConfig.apiKey') \
  -t myapp .
```

## 🔒 セキュリティ注意事項

1. **絶対にコミットしない**
   - `.env`
   - `service-account-key.json`
   - `lib/core/config/env.dart`

2. **.gitignoreに追加**
   ```gitignore
   .env
   *.env
   service-account-key.json
   lib/core/config/env.dart
   ```

3. **CI/CD環境での使用**
   ```yaml
   # GitHub Actions例
   - name: Setup environment
     run: |
       echo "${{ secrets.SERVICE_ACCOUNT_KEY }}" | base64 -d > service-account-key.json
       gcloud auth activate-service-account --key-file=service-account-key.json
       gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
   ```

## 🚀 ワンライナー設定

すべての環境変数を一度に設定：

```bash
# 実行権限を付与
chmod +x scripts/setup_env.sh scripts/setup_dart_env.sh

# 環境変数を自動設定
./scripts/setup_env.sh && ./scripts/setup_dart_env.sh

# Flutter アプリを実行
flutter run
```

## 📝 トラブルシューティング

### gcloud未認証エラー
```bash
gcloud auth login
gcloud config set project gcp-f06-barcode
```

### Firebase CLI未インストール
```bash
npm install -g firebase-tools
firebase login
```

### jqコマンドが見つからない
```bash
# macOS
brew install jq

# Linux
sudo apt-get install jq
```

### APIが有効化されていない
```bash
# 必要なAPIを有効化
gcloud services enable firebase.googleapis.com
gcloud services enable firestore.googleapis.com
gcloud services enable identitytoolkit.googleapis.com
```